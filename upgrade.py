import json
import re
import os

# è¨­å®šæª”æ¡ˆè·¯å¾‘ (å‡è¨­ä½ çš„ json åœ¨ public è³‡æ–™å¤¾)
input_path = 'public/data.json'
output_path = 'public/data.json' # é€™æœƒç›´æ¥è¦†è“‹ï¼Œå¦‚æœä½ æƒ³ä¿ç•™åŸæª”å¯ä»¥æ”¹æˆ 'public/data_new.json'

# å¦‚æœæ‰¾ä¸åˆ°æª”æ¡ˆï¼Œå˜—è©¦åœ¨æ ¹ç›®éŒ„æ‰¾
if not os.path.exists(input_path):
    if os.path.exists('data.json'):
        input_path = 'data.json'
    else:
        print(f"éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° {input_path}ï¼Œè«‹ç¢ºèªä½ çš„ json æª”æ¡ˆä½ç½®ã€‚")
        exit()

with open(input_path, 'r', encoding='utf-8') as f:
    data = json.load(f)

# --- å®šç¾©è™•ç†é‚è¼¯ ---

def parse_risk(text):
    """è§£æåŠ å®³/å—å®³é¢¨éšªæ•¸å€¼"""
    if not text or not isinstance(text, str):
        return {"aggressor": 5, "victim": 5, "desc_a": "", "desc_v": ""}
    
    # æŠ“å–æ•¸å­—
    agg_match = re.search(r'åŠ å®³[:ï¼š]?\s*(\d+(?:\.\d+)?)', text)
    vic_match = re.search(r'å—å®³[:ï¼š]?\s*(\d+(?:\.\d+)?)', text)
    
    # æŠ“å–æ‹¬è™Ÿå…§çš„æ–‡å­—
    agg_desc = re.search(r'åŠ å®³.*?[(ï¼ˆ](.*?)[)ï¼‰]', text)
    vic_desc = re.search(r'å—å®³.*?[(ï¼ˆ](.*?)[)ï¼‰]', text)

    return {
        "aggressor": float(agg_match.group(1)) if agg_match else 5,
        "victim": float(vic_match.group(1)) if vic_match else 5,
        "desc_a": agg_desc.group(1) if agg_desc else "",
        "desc_v": vic_desc.group(1) if vic_desc else ""
    }

def generate_tags(item, risk):
    """ç”Ÿæˆæœå°‹æ¨™ç±¤"""
    tags = []
    text = str(item)
    
    keywords = {
        "ç„¦æ…®å‹": ["ç„¦æ…®", "ä¸å®‰", "é»", "ç¢ºèª"],
        "é€ƒé¿å‹": ["é€ƒé¿", "å†·æ·¡", "è·é›¢", "ç©ºé–“"],
        "æ§åˆ¶å‹": ["æ§åˆ¶", "æ”¯é…", "è¦æ±‚", "è¦å®š"],
        "ä¾è³´å‹": ["ä¾è³´", "é †å¾", "ç„¡åŠ©", "ç…§é¡§"],
        "è‡ªæˆ€å‹": ["è‡ªæˆ€", "å„ªè¶Š", "å´‡æ‹œ", "ç‰¹åˆ¥"],
        "é«˜æ•æ„Ÿ": ["æ•æ„Ÿ", "ç´°è†©", "å—å‚·", "å…±æ„Ÿ"],
        "å®‰å…¨å‹": ["ç©©å®š", "å®‰å…¨", "æºé€š", "ä¿¡ä»»"],
        "é»‘æš—ä¸‰è§’": ["é¦¬åŸº", "æ“æ§", "åˆ©ç”¨", "å†·è¡€", "è¬Šè¨€"],
        "å—å®³è€…é«”è³ª": ["å—å®³", "å§”å±ˆ", "çŠ§ç‰²", "è¨å¥½"]
    }
    
    for tag, keys in keywords.items():
        if any(k in text for k in keys):
            tags.append(tag)
            
    if risk['aggressor'] >= 8: tags.append("é«˜é¢¨éšª")
    if risk['victim'] >= 8: tags.append("æ˜“å—å‚·")
    
    return list(set(tags))

def generate_guides(item, risk):
    """ç”Ÿæˆé»‘åŒ–åˆ†æèˆ‡æ•‘æ´æŒ‡å—"""
    type_name = item.get('type', '')
    dark = ""
    guide = ""
    
    # é»‘åŒ–åˆ†æ logic
    if risk['aggressor'] >= 8:
        dark = "ã€å±éšªè­¦è¨Šã€‘æ­¤äººæ ¼å…·æœ‰æ å¥ªæ€§ã€‚åœ¨å£“åŠ›ä¸‹ï¼Œå‚¾å‘å°‡ä¼´ä¾¶ã€Œç‰©åŒ–ã€æˆ–è¦–ç‚ºå·¥å…·ã€‚æ·±å±¤å¿ƒç†å¯èƒ½æºè‡ªå°ã€Œå¤±æ§ã€çš„ææ‡¼ï¼Œå› æ­¤é¸æ“‡å…ˆä¸‹æ‰‹ç‚ºå¼·ã€‚"
    elif risk['victim'] >= 8:
        dark = "ã€æ˜“å—å®³é«”è³ªã€‘è‡ªæˆ‘é‚Šç•Œæ¥µå…¶æ¨¡ç³Šã€‚æ·±å±¤ä¿¡å¿µèªç‚ºã€ŒçŠ§ç‰²æ‰å€¼å¾—è¢«æ„›ã€ï¼Œæ¥µæ˜“å¸å¼•è‡ªæˆ€æˆ–åç¤¾æœƒå‹ä¼´ä¾¶ï¼Œå½¢æˆé›£ä»¥è„«èº«çš„ã€Œå‰µå‚·é€£çµã€ã€‚"
    elif "é€ƒé¿" in type_name:
        dark = "ã€å†·æš´åŠ›é˜²ç¦¦ã€‘ç•¶æ„Ÿåˆ°è¢«ä¾µå…¥æ™‚ï¼Œæœƒç¬é–“åˆ‡æ–·æƒ…æ„Ÿé€£çµï¼ˆDissociationï¼‰ï¼Œé€™ç¨®ã€Œçªç„¶çš„é™Œç”Ÿæ„Ÿã€æ˜¯å°ä¼´ä¾¶æœ€æ·±çš„ç²¾ç¥æ‰“æ“Šã€‚"
    elif "ç„¦æ…®" in type_name:
        dark = "ã€ç„¦æ…®é»‘åŒ–ã€‘ç•¶ç„¦æ…®é”è‡¨ç•Œé»ï¼Œæœƒè½‰ç‚ºã€Œæƒ…ç·’å‹’ç´¢ã€èˆ‡ã€Œå¼·åˆ¶æ€§è¦ªå¯†ã€ï¼Œé€éè®“å°æ–¹çª’æ¯ä¾†ç·©è§£è‡ªå·±çš„è¢«éºæ£„æ„Ÿã€‚"
    elif "æ§åˆ¶" in type_name:
        dark = "ã€ç§©åºæš´å›ã€‘å°‡ã€Œæ„›ã€æ‰­æ›²ç‚ºã€Œæœå¾ã€ã€‚ç•¶ä½ ä¸é †å¾æ™‚ï¼Œä»–æ„Ÿåˆ°çš„ä¸æ˜¯ç”Ÿæ°£ï¼Œè€Œæ˜¯ã€Œè¢«èƒŒå›ã€çš„ææ…Œï¼Œå› æ­¤æœƒåŠ å€æ–½å£“ã€‚"
    else:
        dark = "ã€æ½›åœ¨é™°å½±ã€‘åœ¨æ¥µç«¯å£“åŠ›ä¸‹ï¼Œå¯èƒ½å±•ç¾å‡ºèˆ‡å¹³æ—¥ç›¸åçš„é˜²è¡›æ©Ÿåˆ¶ï¼ˆä¾‹å¦‚å®‰å…¨å‹è®Šå¾—éåº¦èªªæ•™ã€å†·æ¼ ï¼‰ã€‚"

    # æ•‘æ´æŒ‡å— logic
    if risk['aggressor'] >= 9:
        guide = "ğŸ”´ **é€ƒç”ŸæŒ‡å—**ï¼šä¸è¦è©¦åœ–æ”¹è®Šä»–ã€‚å»ºç«‹ä¸å¯å¦¥å”çš„ç‰©ç†èˆ‡å¿ƒç†ç•Œç·šã€‚è‹¥ç™¼ç¾æƒ…ç·’é•·æœŸè€—ç«­ï¼Œè«‹å°‹æ±‚å°ˆæ¥­å”åŠ©ä¸¦è¨ˆåŠƒå®‰å…¨æ’¤é›¢ï¼ˆNo Contactï¼‰ã€‚"
    elif risk['aggressor'] >= 7:
        guide = "ğŸŸ  **ç›¸è™•é¿é›·**ï¼šæ­¤äººæ ¼åƒè»Ÿä¸åƒç¡¬ï¼Œä½†ã€Œé †å¾ã€åªæœƒæ›ä¾†æ›´å¤šæ§åˆ¶ã€‚å¿…é ˆåœ¨åˆæœŸå°±å±•ç¾å¼·å¤§çš„è‡ªæˆ‘æ¡†æ¶ï¼ˆFrameï¼‰ï¼Œè®“ä»–çŸ¥é“ä½ çš„åº•ç·šä¸å¯ä¾µçŠ¯ã€‚"
    elif risk['victim'] >= 8:
        guide = "ğŸŸ¢ **è‡ªæˆ‘æ•‘æ´**ï¼šä½ çš„èª²é¡Œæ˜¯ã€Œç·´ç¿’è®“åˆ¥äººå¤±æœ›ã€ã€‚åœæ­¢éåº¦åŒç†åŠ å®³è€…ã€‚æ¯å¤©ç·´ç¿’åšä¸€ä»¶ã€Œåªç‚ºäº†è‡ªå·±é–‹å¿ƒã€çš„å°äº‹ï¼Œé‡å»ºè‡ªæˆ‘åƒ¹å€¼ã€‚"
    elif risk['victim'] >= 6:
        guide = "ğŸ”µ **ç™‚ç™’å»ºè­°**ï¼šå­¸ç¿’è­˜åˆ¥ã€Œè‡ªå·±çš„æƒ…ç·’ã€èˆ‡ã€Œä»–äººçš„æƒ…ç·’ã€ã€‚ä½ ä¸éœ€è¦ç‚ºæˆ¿é–“è£¡æ°£æ°›çš„æ”¹è®Šè² è²¬ã€‚ç·´ç¿’èªªã€Œä¸ã€ï¼Œä¸¦è§€å¯Ÿå°æ–¹çš„åæ‡‰ã€‚"
    else:
        guide = "âšª **ç›¸è™•å»ºè­°**ï¼šä¿æŒèª å¯¦èˆ‡ç©©å®šçš„æºé€šã€‚æ­¤é¡å‹äººæ ¼é€šå¸¸èƒ½çµ¦äºˆæ­£å‘å›é¥‹ï¼Œæ˜¯å»ºç«‹é•·æœŸé—œä¿‚çš„è‰¯å¥½å°è±¡ã€‚"

    return dark, guide

# --- åŸ·è¡Œè½‰æ› ---
new_profiles = []
for p in data.get('profiles', []):
    c = p.get('content', {})
    
    # è§£æé¢¨éšª
    risk = parse_risk(c.get('åŠ å®³_å—å®³é¢¨éšª', ''))
    
    # ç”Ÿæˆæ–°å…§å®¹
    tags = generate_tags(p, risk)
    dark, guide = generate_guides(p, risk)
    
    # å»ºç«‹æ–°çµæ§‹
    new_p = {
        "id": p['id'],
        "type": p['type'],
        "category": p.get('type', '').split('Â·')[0] if 'Â·' in p.get('type', '') else "å…¶ä»–",
        "tags": tags,
        "risk": risk,
        "analysis": {
            "dark_side": dark,
            "guide": guide
        },
        # ä¿ç•™åŸå§‹è³‡æ–™ä»¥é˜²è¬ä¸€ï¼Œä½†è½‰ç‚ºè‹±æ–‡ key æ–¹ä¾¿å‰ç«¯è®€å–
        "data": {
            "emotional": c.get('æƒ…ç·’æ¨¡çµ„', ''),
            "cognitive": c.get('èªçŸ¥æ¨¡çµ„', ''),
            "behavioral": c.get('è¡Œç‚ºæ¨¡çµ„', ''),
            "attachment": c.get('ä¾é™„æ¨¡çµ„', ''),
            "control": c.get('æ§åˆ¶æ¨¡çµ„', ''),
            "submission": c.get('é †å¾_è¢«æ§åˆ¶æ¨¡çµ„', ''),
            "background": c.get('äººæ ¼ç™¼å±•èƒŒæ™¯', ''),
            "interaction": c.get('é—œä¿‚ä¸åŒéšæ®µçš„äº’å‹•æ¨¡å¼', ''),
            "dialogue": c.get('å¸¸è¦‹å…§åœ¨å°è©±', ''),
            "defense": c.get('é˜²è¡›æ©Ÿåˆ¶', ''),
            "cold_read": c.get('å†·è®€æ¨¡çµ„', ''),
            "cold_sentence": c.get('å†·è®€å¥', ''),
            "case": c.get('æ¡ˆä¾‹_ç´°ç¯€', '')
        }
    }
    new_profiles.append(new_p)

# å¯«å…¥æª”æ¡ˆ
data['profiles'] = new_profiles
data['file_metadata']['description'] += " (å·²å‡ç´šï¼šå«é»‘åŒ–åˆ†æèˆ‡æ•‘æ´æŒ‡å—)"

with open(output_path, 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"æˆåŠŸï¼å·²è™•ç† {len(new_profiles)} ç­†è³‡æ–™ï¼Œæª”æ¡ˆå·²å„²å­˜è‡³ {output_path}")